on:
  workflow_call:
    outputs:
      image:
        description: Docker Image Uri
        value: ${{ jobs.build_and_push.outputs.image }}
    inputs:
      RepositoryName:
        required: true
        type: string
      ImageTag:
        required: false
        type: string
        default: latest
      AssumeRoleArn:
        required: true
        type: string
      AwsRegion:
        required: false
        type: string
        default: ap-northeast-2

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    outputs:
      image: ${{ steps.digest.outputs.image }}

    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@main

      - name: Configure AWS credentials ðŸ”‘
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.AssumeRoleArn }}
          aws-region: ${{ inputs.AwsRegion }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup ECR Repository
        uses: deploy-actions/setup-ecr@main
        with:
          RepositoryName: ${{ inputs.RepositoryName }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Build
        uses: docker/build-push-action@v6
        with:
          load: true
          tags: ${{ steps.ecr.outputs.registry }}/${{ inputs.RepositoryName }}:${{ inputs.ImageTag }}

      - name: Docker Push
        id: digest
        run: |
          Image=${{ steps.ecr.outputs.registry }}/${{ inputs.RepositoryName }}:${{ inputs.ImageTag }}
          docker push $Image
          echo "image=$(docker inspect --format '{{index .RepoDigests 0}}' $Image)" >> "$GITHUB_OUTPUT"
